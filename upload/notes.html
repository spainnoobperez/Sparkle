<!doctype html>

<html>

<head>
<title>Sparkle</title>
<meta charset="UTF-8">
<style type="text/css">
h1
{
    border-width: 1;
    border: solid;
    text-align: center;
    color: white;
    background-color: darkmagenta;
}
div.code
{
    font-family: monospace;
    color: midnightblue;
    background-color: skyblue;
}
span.file
{
    font-family: monospace;
    color: purple;
    background-color: pink;
}
</style>
</head>

<body><div>

<h1>Sparkle</h1>


<div class="section">
<h2>Требования</h2>
<p>
Программе требуется андроид версии 6 или выше. Что? Я не виноват, что критически важные для любой ОС API появились
в андроиде только спустя 7 лет. Если что, речь о возможности добавить fd listener. Его, конечно, можно заменить на
таймер и тем самым понизить требуемую версию до 5, но это создаст постоянную нагрузку на процессор (хоть и меньше 1%).
</p>
</div>


<div class="section">
<h2>Вступление (для новичков)</h2>
<p>
Далее описывается много всякой сложной хрени. Это нужно для тех, кто хочет всё понять и сделать вручную.
В принципе, понимать и делать всю эту хрень не обязательно. Вот самая простая инструкция:
</p>
<ol>
<li>
Установить и запустить apk.
</li>
<li>
Смонтировать дистрибутив в Linux Deploy. Установить в нем Xwayland. Убедиться, что в домашней директории
(<span class="file">~/</span>)
пользователя есть файл <span class="file">.xinitrc</span>, в котором указано, какое запускать окружение (или хоть xterm).
</li>
<li>
Скачать скрипт <span class="file">user.sh</span>, изменить в нем путь к точке монтирования дистрибутива и имя пользователя.
</li>
<li>
Забросить скрипт на устройство и запустить вот так:
<div class="code">
# в андроиде<br>
./user.sh start
</div>
</li>
<li>
Если всё заработает, можно установить скрипт вот так:
<div class="code">
# в андроиде<br>
./user.sh install
</div>
тогда он будет выполняться автоматически при старте sparkle. А если не заработает, покажите вывод скрипта в
теме Linux Deploy и старик Батуев его исправит. Если хотите, можно добавить в скрипт несколько строчек (mount-ов)
и тогда Linux Deploy будет не нужен.
</li>
</ol>
</div>


<div class="section">
<h2>Подробности</h2>
<ol>
<li>
Sparkle создает сокет (файл) <span class="file">/data/data/com.sion.sparkle/wayland-0</span>.
Если вы используете chroot, необходимо сделать этот файл доступным изнутри директории с дистрибутивом.
Самый простой способ - это смонтировать <span class="file">/data</span> в директорию дистрибутива:
<div class="code">
# в андроиде, от рута<br>
mkdir -p путь_к_директории_дистрибутива/data<br>
mount -o bind /data путь_к_директории_дистрибутива/data
</div>
Но, если вы так сделаете, лучше бы вам об этом не забыть и не попытаться удалить дистрибутив командой
<div class="code">
rm -rf
</div>
</li>
<li>
Wayland клиентам (включая xwayland) для работы нужна специальная директория (XDG_RUNTIME_DIR).
Владельцем директории должен быть пользователь, который будет запускать клиент (не обязательно root).
Лучше создать новую директорию на tmpfs.
Если вы используете chroot, проверьте смонтировано ли у вас tmpfs на <span class="file">/tmp</span>.
Если нет, смонтируйте:
<div class="code">
# в дистрибутиве, от рута<br>
mount -t tmpfs tmpfs /tmp
</div>
Затем создайте директорию от имени вашего основного пользователя
(название не обязательно должно быть <span class="file">runtime</span>):
<div class="code">
# в дистрибутиве, от пользователя<br>
mkdir /tmp/runtime
</div>
Если клиент запускается в окружении андроида (без chroot), всё, в принципе, так же.
Точкой монтирования tmpfs не обязательно должно быть <span class="file">/tmp</span>.
</li>
<li>
Создайте симлинк на <span class="file">/data/data/com.sion.sparkle/wayland-0</span> в вашей XDG_RUNTIME_DIR:
<div class="code">
ln -s /data/data/com.sion.sparkle/wayland-0 /tmp/runtime/
</div>
</li>
<li>
Теперь нужно либо отключить SELinux:
<div class="code">
# в андроиде, от рута<br>
setenforce 0
</div>
либо изменить контекст на вашей XDG_RUNTIME_DIR. Есть три варианта. Сначала попробуйте такой:
<div class="code">
# в андроиде, от рута<br>
restorecon путь_к_директории_дистрибутива/tmp<br>
restorecon путь_к_директории_дистрибутива/tmp/runtime
</div>
Если не сработает, можно изменить контекст на вот такой:
<div class="code">
# в андроиде, от рута<br>
chcon "u:object_r:app_data_file:s0" путь_к_директории_дистрибутива/tmp<br>
chcon "u:object_r:app_data_file:s0" путь_к_директории_дистрибутива/tmp/runtime
</div>
А если и это не сработает, то можно посмотреть контекст на директории sparkle
и установить для XDG_RUNTIME_DIR такой же:
<div class="code">
# в андроиде, от рута<br>
ls -Z /data/data/com.sion.sparkle
</div>
</li>
<li>
Попробуйте запустить xwayland (или другой клиент):
<div class="code">
export XDG_RUNTIME_DIR=/tmp/runtime<br>
Xwayland<br>
</div>
</li>
</ol>
</div>


<div class="section">
<h2>Логи</h2>
<p>
Лог в файле <span class="file">/data/data/com.sion.sparkle/log.txt</span>.
Читать его в реальном времени можно вот так:
<div class="code">
tail -f /data/data/com.sion.sparkle/log.txt
</div>
</p>
</div>


<div class="section">
<h2>Функция "адский скрипт"</h2>
<p>
При нажатии кнопки "Start" sparkle не только запускает сервис, но еще пытается выполнить скрипт
<span class="file">/data/data/com.sion.sparkle/user.sh</span>, если таковой имеется.
Скрипту будет передан аргумент "start".
Этот скрипт можно использовать, например, для того, чтобы автоматически запускать xwayland и окружение.
Но тут есть два важных момента. Во-первых, скрипт вызывается <b>каждый</b> раз, когда вы нажимаете "Start".
Если вы собираетесь в этом скрипте что-то куда-то монтировать, создавать файлы или запускать процессы,
то обязательно нужно проверить, не сделано ли это уже. Маунты сохраняются до перезагрузки устройства,
а sparkle может скрашиться и раньше. Во-вторых, скрипту, скорее всего, придется использовать busybox или утилиты
в окружении андроида. Работа последних может отличаться на разных устройствах. Скрипт, который работает на одном
устройстве, может и не заработать на другом. Пример скрипта есть рядом с apk.
Вывод скрипта пишется в <span class="file">/data/data/com.sion.sparkle/user_log.txt</span>.
</div>
</p>
</div>


<div class="section">
<h2>Мутные экраны</h2>
<p>
Выяснилось, что встречаются устройства (по крайней мере, одно), на которых попытка перерисовывать только часть экрана
(а не весь экран целиком) вызывает аномальную нагрузку на процессор и тормоза.
Посмотрите лог <span class="file">/data/data/com.sion.sparkle/log.txt</span>.
Там отображается нагрузка на процессор (на одно ядро).
Если при, например, просмотре видео она поднимается выше 40-50%, то это фигово и, вероятно,
у вас одно из таких устройств. Можете попробовать включить no_damage в настройках.
</p>
</div>


<div class="section">
<h2>Звук</h2>
<p>
Скомпилировать и установить драйвер из архива <span class="file">pcm_sparkle.tar.gz</span>:
<div class="code">
make<br>
sudo make install
</div>
Кроме компилятора, наверняка понадобится установить пакет с заголовками alsa. В debian он называется
<span class="file">libasound2-dev</span>, в fedora - <span class="file">alsa-lib-devel</span>.
Переименовать файл <span class="file">1.asoundrc</span> в <span class="file">.asoundrc</span>
и забросить в домашнюю директорию пользователя (<span class="file">~/</span>).
Для проверки запустить mplayer или mpv как-то так:
<div class="code">
mplayer -vo x11 -ao alsa -lavdopts threads=4 anime.mkv
</div>
Есть вероятность, что драйвер установится не в ту директорию. Тогда проигрыватель выбьет ошибку и покажет,
в какой директории должен быть драйвер. Скопируйте его туда вручную.
</p>
</div>


<div class="section">
<h2>Настройки</h2>
<p>
Настройки в файле <span class="file">/data/data/com.sion.sparkle/settings.lua</span>.
Файл считывается только в момент запуска sparkle (короче, если что-то изменили, надо перезапускать sparkle).
На данный момент доступны следующие опции:
</p>
<ul>
<li>
upload_mode - способ вывода изображения. 0 - самый быстрый.
1 - немного медленнее, но может решить проблему мигания/просвечивания. 2 - очень медленный, но почти гарантированно
решает проблему мигания/просвечивания.
</li>
<li>
no_damage - отключение damage. Если установить "true", будет перерисовываться весь экран, а не только изменившийся
участок. Полезно для устройств с "мутными" экранами.
</li>
<li>
DPI - Почему-то не работает. Хотя xrandr показывает правильный физический размер экрана. Не ясно.
</li>
</ul>
</div>



<br><br>
</div></body>

</html>
