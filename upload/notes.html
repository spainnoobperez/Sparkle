<!doctype html>

<html>

<head>
<title>Sparkle</title>
<meta charset="UTF-8">
</head>

<body>
<div>

<b>Требования</b><br>
<br>
Программе требуется андроид версии 6 или выше. Что? Я не виноват, что критически важные для любой ОС API появились
в андроиде только спустя 7 лет. Если что, речь о возможности добавить fd listener. Его, конечно, можно заменить на
таймер и тем самым понизить требуемую версию до 5, но это создаст постоянную нагрузку на процессор (хоть и меньше 1%).
<br>
<br>


<b>Вступление (для новичков)</b><br>
<br>

Далее описывается много всякой сложной хрени. Это нужно для тех, кто хочет всё понять и сделать вручную.
В принципе, понимать и делать всю эту хрень не обязательно. Вот самая простая инструкция:<br>
1. Установить и запустить apk;<br>
2. Смонтировать дистрибутив в Linux Deploy; установить в нем Xwayland; убедиться, что в домашней директории (~/)
пользователя есть файл .xinitrc, в котором указано, какое запускать окружение (или хоть xterm);<br>
3. Скачать скрипт <code>user.sh</code>, изменить в нем путь к точке монтирования дистрибутива и имя пользователя;<br>
4. Забросить скрипт на устройство и запустить вот так:<br>
<code>
# в андроиде<br>
./user.sh start<br>
</code>
Если всё заработает, можно установить скрипт вот так:<br>
<code>
# в андроиде<br>
./user.sh install<br>
</code>
тогда он будет выполняться автоматически при старте sparkle. А если не заработает, покажите вывод скрипта в
теме Linux Deploy и старик Батуев его исправит. Если хотите, можно добавить в скрипт несколько строчек (mount-ов)
и тогда Linux Deploy будет не нужен.<br>
<br>
<br>


<b>Условия для запуска xwayland на sparkle</b><br>
<br>

1. sparkle создает сокет (файл) <code>/data/data/com.sion.sparkle/wayland-0</code>.
Если вы используете chroot, необходимо сделать этот файл доступным изнутри директории с дистрибутивом.
Самый простой способ - это смонтировать <code>/data</code> в директорию дистрибутива:<br>
<code>
# в андроиде, от рута<br>
mkdir -p путь_к_директории_дистрибутива/data<br>
mount -o bind /data путь_к_директории_дистрибутива/data<br>
</code>
Но, если вы так сделаете, лучше бы вам об этом не забыть и не попытаться удалить дистрибутив командой
<code>rm -rf</code>.<br>
<br>

2. wayland клиентам (включая xwayland) для работы нужна специальная директория (XDG_RUNTIME_DIR).
Владельцем директории должен быть пользователь, который будет запускать клиент (не обязательно root).
Лучше создать новую директорию на tmpfs.
Если вы используете chroot, проверьте смонтировано ли у вас tmpfs на <code>/tmp</code>. Если нет, смонтируйте:<br>
<code>
# в дистрибутиве, от рута<br>
mount -t tmpfs tmpfs /tmp<br>
</code>
Затем создайте директорию от имени вашего основного пользователя (название не обязательно должно быть "runtime"):<br>
<code>
# в дистрибутиве, от пользователя<br>
mkdir /tmp/runtime<br>
</code>
Если клиент запускается в окружении андроида (без chroot), всё, в принципе, так же.
Точкой монтирования tmpfs не обязательно должно быть <code>/tmp</code>.<br>
<br>

3. Создайте симлинк на <code>/data/data/com.sion.sparkle/wayland-0</code> в вашей XDG_RUNTIME_DIR:<br>
<code>
ln -s /data/data/com.sion.sparkle/wayland-0 /tmp/runtime/<br>
</code>
<br>

4. К сожалению (вот облом) со включенным SELinux ничерта не работает.
Если не передумали экспериментировать, отключите SELinux:<br>
<code>
# в андроиде, от рута<br>
setenforce 0<br>
</code>
После запуска клиента можно включить SELinux обратно:<br>
<code>
# в андроиде, от рута<br>
setenforce 1<br>
</code>
<br>
Update: Так, отключать SELinux теперь не обязательно. Возможно, в первый раз лучше проверить с отключенным,
но потом можно сделать иначе. Нам нужно изменить SELinux контекст на нашей XDG_RUNTIME_DIR или на её паренте.
Есть три варианта. Можно попробовать restorecon:<br>
<code>
# в андроиде, от рута<br>
restorecon путь_к_директории_дистрибутива/tmp<br>
restorecon путь_к_директории_дистрибутива/tmp/runtime<br>
</code>
Если не сработает, можно изменить контекст на вот такой:<br>
<code>
# в андроиде, от рута<br>
chcon "u:object_r:app_data_file:s0" путь_к_директории_дистрибутива/tmp<br>
chcon "u:object_r:app_data_file:s0" путь_к_директории_дистрибутива/tmp/runtime<br>
</code>
А если и это не сработает, то можно посмотреть контекст на директории sparkle
и установить для XDG_RUNTIME_DIR такой же:<br>
<code>
# в андроиде, от рута<br>
ls -Z /data/data/com.sion.sparkle/<br>
</code>
<br>

5. Попробуйте запустить xwayland (или другой клиент):<br>
<code>
export XDG_RUNTIME_DIR=/tmp/runtime<br>
Xwayland<br>
</code>
<br>

6. А, ну еще важным условием для запуска xwayland является наличие установленного xwayland :)<br>
<br>
<br>

<b>Отладка</b><br>
<br>
Лог в файле <code>/data/data/com.sion.sparkle/log.txt</code>.
Читать его в реальном времени можно вот так:<br>
<code>
tail -f /data/data/com.sion.sparkle/log.txt<br>
</code>
<br>
<br>

<b>Функция "адский скрипт"</b><br>
<br>
При нажатии кнопки "Start" sparkle не только запускает сервис, но еще пытается выполнить скрипт
<code>/data/data/com.sion.sparkle/user.sh</code>, если таковой имеется. Скрипту будет передан аргумент "start".
Этот скрипт можно использовать, например, для того, чтобы автоматически запускать xwayland и окружение.
Но тут есть два важных момента. Во-первых, скрипт вызывается _каждый_ раз, когда вы нажимаете "Start".
Если вы собираетесь в этом скрипте что-то куда-то монтировать, создавать файлы или запускать процессы,
то обязательно нужно проверить, не сделано ли это уже. Маунты сохраняются до перезагрузки устройства,
а sparkle может скрашиться и раньше. Во-вторых, скрипту, скорее всего, придется использовать busybox или утилиты
в окружении андроида. Работа последних может отличаться на разных устройствах. Скрипт, который работает на одном
устройстве, может и не заработать на другом. Пример скрипта есть рядом с apk. Вывод скрипта пишется в
<code>/data/data/com.sion.sparkle/user_log.txt</code>.<br>
<br>
<br>

<b>Мутные экраны</b><br>
<br>
Выяснилось, что встречаются устройства (по крайней мере, одно), на которых попытка перерисовывать только часть экрана
(а не весь экран целиком) вызывает аномальную нагрузку на процессор и тормоза.
Посмотрите лог <code>/data/data/com.sion.sparkle/log.txt</code>. Там отображается нагрузка на процессор (на одно ядро).
Если при, например, просмотре видео она поднимается выше 40-50%, то это фигово и, вероятно, у вас одно из таких устройств.
Можете написать мне на почту (ir0h@tutanota.com) и я сброшу специальную версию c полными перерисовками.<br>
<br>
<br>

<b>Звук</b><br>
<br>
Скомпилировать и установить драйвер из архива "pcm_sparkle.tar.gz":<br>
<code>
make<br>
sudo make install<br>
</code>
Кроме компилятора, наверняка понадобится установить пакет с заголовками alsa. В debian он называется "libasound2-dev",
в fedora - "alsa-lib-devel". Переименовать файл "1.asoundrc" в ".asoundrc" и забросить в домашнюю директорию
пользователя (~/). Для проверки запустить mplayer или mpv как-то так:<br>
<code>
mplayer -vo x11 -ao alsa anime.mkv<br>
</code>
Есть вероятность, что драйвер установится не в ту директорию. Тогда проигрыватель выбьет ошибку и покажет,
в какой директории должен быть драйвер. Скопируйте его туда вручную.
<br>
<br>

</div>
</body>

</html>
